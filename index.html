<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è¬è§£ãå¾©å·</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 640px;
        margin: 40px auto;
        padding: 0 16px;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        font-size: 16px;
      }
      button {
        margin-top: 10px;
        cursor: pointer;
      }
      .msg {
        margin-top: 18px;
        font-size: 22px;
        font-weight: 700;
      }
      .err {
        margin-top: 18px;
        color: #b00020;
      }
      small {
        color: #666;
      }
      .guide {
        margin-bottom: 28px;
      }
      .guide details {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 10px;
        background: #fafafa;
      }
      .guide summary {
        cursor: pointer;
        font-weight: 600;
      }
      .guide-body {
        margin-top: 12px;
        line-height: 1.8;
      }
      .guide .lead {
        margin-bottom: 12px;
      }
      .guide h3 {
        margin: 16px 0 6px;
        font-size: 1.05em;
      }
      .guide .cipher {
        background: #f0f0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 1.05em;
        letter-spacing: 0.05em;
      }
      .guide .note {
        font-size: 0.9em;
        color: #555;
      }
      .guide .q {
        margin: 6px 0;
      }
      .guide ul {
        margin: 6px 0 6px 20px;
      }
    </style>
  </head>
  <body>
    <h1>è¬è§£ã</h1>

    <section class="guide">
      <details open>
        <summary>ğŸ§© éŠã³æ–¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>

        <div class="guide-body">
          <p class="lead">
            ã“ã®ãƒšãƒ¼ã‚¸ã¯ <b>è¬è§£ã â†’ å¤å…¸æš—å· â†’ å¾©å·</b> ã®ä¸‰æ®µæ§‹æˆã§ã™ã€‚<br />
            ç´™ã¨é‰›ç­†ã‚’ä½¿ã£ã¦è§£ã„ã¦ãã ã•ã„ã€‚
          </p>

          <h3>Step 0ï¼šæš—å·æ–‡</h3>
          <pre class="cipher">GXXFDGXAAGXDAGDAGAFFGAFDGGFF</pre>
          <p class="note">â€» I ã¨ J ã¯åŒä¸€æ‰±ã„ï¼ˆJ ã¯ I ã¨ã—ã¦æ‰±ã†ï¼‰</p>

          <h3>Step 1ï¼šæ–¹é™£ã‚­ãƒ¼ã‚’å¾—ã‚ˆï¼ˆè¬1ï¼‰</h3>
          <p class="q">
            ã€Œä¸€å¹´ã®ã†ã¡ã€ã‚‚ã£ã¨ã‚‚å¤šãã®äººãŒâ€œåŒã˜è¨€è‘‰â€ã‚’å£ã«ã™ã‚‹æ—¥ã€<br />
            ãã®æ—¥ã«ã€ä¸–ç•Œä¸­ã§ä½¿ã‚ã‚Œã‚‹è‹±èªã®è¨€è‘‰ã‚’ç­”ãˆã‚ˆã€‚
          </p>
          <p class="note">å½¢å¼ï¼šè‹±å¤§æ–‡å­—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãªã—</p>

          <h3>Step 2ï¼šè»¢ç½®ã‚­ãƒ¼ã‚’å¾—ã‚ˆï¼ˆè¬2ï¼‰</h3>
          <p class="q">
            ã€Œæ­£æœˆã«é£Ÿã¹ã‚‹ã€ç”˜ã„ã‚‚ã®ã€<br />
            ã²ã‚‰ãŒãªã‚’ãã®ã¾ã¾ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«ç›´ã›ã€‚
          </p>
          <p class="note">å½¢å¼ï¼šè‹±å¤§æ–‡å­—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãªã—</p>

          <h3>Step 3ï¼šæš—å·ã‚’è§£ã‘</h3>
          <ul>
            <li>Step 1ãƒ»2 ã§å¾—ãŸ <b>2ã¤ã®éµ</b> ã‚’ä½¿ã†</li>
            <li>æš—å·æ–¹å¼ã¯ <b>ADFGXæš—å·</b></li>
            <li>è»¢ç½® â†’ æ–¹é™£ã®é †ã§å¾©å·ã™ã‚‹</li>
          </ul>

          <h3>Step 4ï¼šç­”ãˆã‚’å…¥åŠ›</h3>
          <p>
            å¾©å·ã—ã¦å¾—ã‚‰ã‚ŒãŸ
            <b>è‹±å­—åˆ—</b> ã‚’ã€ã“ã®ãƒšãƒ¼ã‚¸ä¸‹ã®å…¥åŠ›æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      </details>

      <details>
        <summary>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼ˆè©°ã¾ã£ãŸã‚‰ï¼‰</summary>
        <div class="guide-body">
          <p><b>ãƒ’ãƒ³ãƒˆ1ï¼š</b> æ–°å¹´ã®æŒ¨æ‹¶ã‚’è‹±èªã§ã€‚</p>
          <p><b>ãƒ’ãƒ³ãƒˆ2ï¼š</b> æ­£æœˆã«é£Ÿã¹ã‚‹ã€ç™½ãã¦ä¼¸ã³ã‚‹ã‚‚ã®ã€‚</p>
          <p><b>ãƒ’ãƒ³ãƒˆ3ï¼š</b> æš—å·æ–‡ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹æ–‡å­—ã¯5ç¨®é¡ã—ã‹ãªã„ã€‚</p>
        </div>
      </details>
    </section>

    <p>ç­”ãˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æš—å·æ–‡ãŒè§£èª­ã•ã‚Œã¾ã™ã€‚</p>

    <input id="answer" placeholder="è¬è§£ãã®ç­”ãˆ" autocomplete="off" />
    <button id="btn">è§£èª­</button>

    <div id="out"></div>

    <script>
      const CIPHERTEXT_B64 =
        "Z2GpvfGuSOabNZMHAPuEQDOySAtpi+h3FxmOK1SZ4uQi55f7BPuJViCXwo+HlA==";

      const SALT = new TextEncoder().encode("newyear_salt_v1");
      const IV = Uint8Array.from([
        12, 45, 88, 201, 34, 76, 99, 18, 54, 210, 77, 6,
      ]);

      const $answer = document.getElementById("answer");
      const $btn = document.getElementById("btn");
      const $out = document.getElementById("out");

      $btn.addEventListener("click", async () => {
        $out.textContent = "";
        try {
          const normalized = normalizeAnswer($answer.value);
          if (!normalized) {
            $out.innerHTML = `<div class="err">ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>`;
            return;
          }

          const cryptoKey = await deriveAesKey(normalized, SALT);
          const plaintext = await decryptAesGcmB64(
            CIPHERTEXT_B64,
            cryptoKey,
            IV
          );

          $out.innerHTML = `<div class="msg">${escapeHtml(plaintext)}</div>`;
        } catch {
          $out.innerHTML = `<div class="err">è§£èª­ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç­”ãˆãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚</div>`;
        }
      });

      function normalizeAnswer(s) {
        // ç©ºç™½å‰Šé™¤ã€å…¨è§’â†’åŠè§’ã€å¤§å°ç„¡è¦–ã€è¨˜å·é™¤å»
        return (s ?? "")
          .trim()
          .toLowerCase()
          .normalize("NFKC")
          .replace(/\s+/g, "") // ã‚¹ãƒšãƒ¼ã‚¹å…¨å‰Šé™¤
          .replace(/[ï¼-ï½]/g, (ch) =>
            String.fromCharCode(ch.charCodeAt(0) - 0xfee0)
          ) // å…¨è§’è¨˜å·â†’åŠè§’
          .replace(/[^\p{L}\p{N}]/gu, ""); // æ–‡å­—/æ•°å­—ä»¥å¤–ã‚’æ¶ˆã™ï¼ˆæ—¥æœ¬èªã‚‚OKï¼‰
      }

      async function deriveAesKey(passphrase, saltBytes) {
        const baseKey = await crypto.subtle.importKey(
          "raw",
          new TextEncoder().encode(passphrase),
          "PBKDF2",
          false,
          ["deriveKey"]
        );
        return crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: saltBytes,
            iterations: 150000,
            hash: "SHA-256",
          },
          baseKey,
          { name: "AES-GCM", length: 256 },
          false,
          ["decrypt"]
        );
      }

      async function decryptAesGcmB64(cipherB64, cryptoKey, ivBytes) {
        const cipherBytes = Uint8Array.from(atob(cipherB64), (c) =>
          c.charCodeAt(0)
        );
        const plainBuf = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: ivBytes },
          cryptoKey,
          cipherBytes
        );
        return new TextDecoder().decode(plainBuf);
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
    </script>
  </body>
</html>
